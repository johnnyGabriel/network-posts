$(function(){{var t=Backbone.Model.extend({defaults:{user:{id:1,username:"Visitante",avatar:"assets/images/avatar.png"},date:"",content:"",likes:"",share:""},toTemplate:function(){var t=this.toJSON();return t.timeSincePost=this.timeSincePost(),t},timeSincePost:function(){for(var t=[[1e3,"segundo"],[60,"minuto"],[60,"hora"],[24,"dia"],[7,"semana"],[4,"mese"],[12,"ano"]],e=Date.now()-Date.parse(this.get("date")),s=e,n=0;n<t.length&&(s/=t[n][0])>1;)e=s,n++;return 0===n?"agora mesmo":parseInt(e)+" "+(1===parseInt(e)?t[n-1][1]:t[n-1][1]+"s")+" atrás"},like:function(){this.set({likes:this.get("likes")+1})},share:function(){this.set({share:this.get("share")+1})}}),e=Backbone.Collection.extend({model:t,initialize:function(){this.readLocal()},saveLocal:function(){localStorage.setItem("posts",JSON.stringify(this.models))},readLocal:function(){var t=localStorage.getItem("posts");this.add(t?JSON.parse(t):{user:{id:0,username:"Johnny Pestana",avatar:"assets/images/johnny-avatar.jpg"},date:"2015-07-22T19:34:22.720Z",content:"Olá, seja bem-vindo!",likes:10,share:2})}}),s=Backbone.View.extend({tagName:"div",className:"post-container",template:$("#post-view-template").html(),events:{"click .post-delete":"deletePost","click .post-like":"likePost","click .post-share":"sharePost"},render:function(){var t=Mustache.to_html(this.template,this.model.toTemplate());return this.$el.html(t),this},removePost:function(){this.$el.slideUp("normal",function(){this.remove()})},deletePost:function(){this.model.unset("user")},likePost:function(){this.model.like()},sharePost:function(){this.model.share()}}),n=Backbone.View.extend({template:$("#insert-post-template").html(),events:{"keyup #postContent":"enablePostButton",submit:"insertPost"},initialize:function(t){this.render()},render:function(){var t=Mustache.to_html(this.template,this.model.toJSON());return this.$el.html(t),this.inputContent=this.$el.find("#postContent"),this.submitButton=this.$el.find("input[type='submit']"),this},enablePostButton:function(){this.inputContent.val().length>0?this.submitButton.prop("disabled",!1):this.submitButton.prop("disabled",!0)},insertPost:function(t){t.preventDefault(),this.model.set({date:new Date,content:this.inputContent.val(),likes:0,share:0}),this.render()}}),o=Backbone.View.extend({el:".container",initialize:function(){_.bindAll(this,"showPost","showAllPosts"),this.elFormInsert=this.$el.find("#form-insert-post"),this.elPosts=this.$el.find("#container-posts"),this.newPostModel=new t,this.newPostModel.on("change",function(t){this.postCollection.add(t.clone())},this);var s=new n({model:this.newPostModel});this.elFormInsert.append(s.render().el),this.postCollection=new e,this.postCollection.on("update",function(){this.postCollection.saveLocal()},this),this.postCollection.on("add",function(t){this.showPost(t)},this),this.showAllPosts()},showPost:function(t){var e=new s({model:t});t.on("change:user",function(t){e.removePost(),this.postCollection.remove(t)},this),t.on("change:likes",function(){e.render(),this.postCollection.saveLocal()},this),t.on("change:share",function(){e.render(),this.postCollection.saveLocal()},this),this.elPosts.prepend(e.render().el),e.$el.slideDown("normal"),setInterval(function(){e.render()},6e4)},showAllPosts:function(){this.elPosts.html(""),this.postCollection.each(this.showPost)}});new o}});