$(function(){{var t=Backbone.Model.extend({defaults:{user:{id:1,username:"Visitante",avatar:"assets/images/avatar.png"},date:null,content:null,likes:0,share:0},validate:function(t){return 0===t.content.length?"Dados inválidos!":void 0},toTemplate:function(){var t=this.toJSON();return t.timeSincePost=this.timeSincePost(),t},timeSincePost:function(){for(var t=[[1e3,"segundo","segundos"],[60,"minuto","minutos"],[60,"hora","horas"],[24,"dia","dias"],[7,"semana","semanas"],[4,"mês","meses"],[12,"ano","anos"]],e=Date.now()-Date.parse(this.get("date")),s=e,n=0;n<t.length&&(s/=t[n][0])>1;)e=s,n++;return 0===n?"agora mesmo":parseInt(e)+" "+(1===parseInt(e)?t[n-1][1]:t[n-1][2])+" atrás"},like:function(){this.set({likes:this.get("likes")+1})},share:function(){this.set({share:this.get("share")+1})}}),e=Backbone.Firebase.Collection.extend({model:t,url:new Firebase("https://backbone-posts.firebaseio.com/posts").limitToLast(10),saveLocal:function(){localStorage.setItem("posts",JSON.stringify(this.models))},readLocal:function(){var t=localStorage.getItem("posts");this.add(t?JSON.parse(t):{user:{id:0,username:"Johnny Pestana",avatar:"assets/images/johnny-avatar.jpg"},date:"2015-07-22T19:34:22.720Z",content:"Olá, seja bem-vindo!",likes:10,share:2})}}),s=Backbone.View.extend({tagName:"div",className:"post-container",template:$("#post-view-template").html(),events:{"click .post-delete":"deletePost","click .post-like":"likePost","click .post-share":"sharePost"},render:function(){var t=Mustache.to_html(this.template,this.model.toTemplate());return this.$el.html(t),this},remove:function(){this.$el.slideUp("normal",function(){this.remove()})},deletePost:function(){this.model.destroy()},likePost:function(){this.model.like()},sharePost:function(){this.model.share()}}),n=Backbone.View.extend({template:$("#insert-post-template").html(),events:{"input #postContent":"enablePostButton",keyup:"insertPost",submit:"insertPost"},initialize:function(){this.render(),this.inputContent=this.$el.find("#postContent"),this.submitButton=this.$el.find("input[type='submit']")},render:function(){var t=Mustache.to_html(this.template,this.model.toJSON());this.$el.html(t)},reset:function(){this.$el.find("textarea").val(""),this.enablePostButton()},enablePostButton:function(){this.inputContent.val().length>0?this.submitButton.prop("disabled",!1):this.submitButton.prop("disabled",!0)},insertPost:function(t){return"keyup"===t.type&&13!==t.which?!1:(t.preventDefault(),this.model.set("date",(new Date).toISOString()),this.model.set("content",this.inputContent.val().replace(/\n/g,"")),void(this.model.isValid()&&(this.collection.add(this.model.clone().attributes),this.reset())))}}),i=Backbone.View.extend({el:".container",initialize:function(){_.bindAll(this,"showPost","showAllPosts"),this.elFormInsert=this.$el.find("#form-insert-post"),this.elPosts=this.$el.find("#container-posts"),this.collection=new e,this.collection.on({add:this.showPost},this);new n({model:new t,collection:this.collection,el:this.elFormInsert})},showPost:function(t){var e=new s({model:t});e.model.on({destroy:e.remove,"change:likes change:share":e.render},e),this.elPosts.prepend(e.render().el).promise().done(function(){e.$el.slideDown(600)}),setInterval(_.bind(e.render,e),6e4)},showAllPosts:function(){this.elPosts.html(""),this.collection.each(this.showPost)}});new i}});